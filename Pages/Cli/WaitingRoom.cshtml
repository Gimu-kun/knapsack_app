@page "/room"
@model knapsack_app.Pages.Cli.WaitingRoomModel
@{
    Layout = "_Cli_Layout";
}

<section class="py-2 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex sm:flex-column">
            <div class="flex-1 text-center mb-10">
                <h1 class="text-4xl font-extrabold tracking-tight text-indigo-700">
                    Ph√≤ng Ch·ªù
                </h1>
                <p class="mt-4 text-xl text-gray-600">M√£ Ph√≤ng c·ªßa b·∫°n:</p>
                <div class="flex items-center inline-block p-4 mt-2 bg-white border-4 border-indigo-400 rounded-xl shadow-lg transform hover:scale-[1.01] transition duration-200 cursor-pointer">
                    <span id="room-id-display" class="text-3xl font-mono text-indigo-900 tracking-wider font-extrabold select-all" onclick="navigator.clipboard.writeText('@Model.Id'); alert('ƒê√£ sao ch√©p m√£ ph√≤ng!')">
                        @Model.Id 
                    </span>
                </div>
            </div>

            <div class="flex-1 mx-5 mb-10 p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        üëë C√†i ƒë·∫∑t tr√≤ ch∆°i
                    </h2>
                    <span id="difficulty-display" class="text-xl font-extrabold text-green-600">D·ªÑ</span> 
                </div>
                
                <div id="host-difficulty-control" class="mt-4 hidden">
                    <label for="difficulty-select" class="block text-sm font-medium text-gray-700 mb-2">Ch·ªçn ƒê·ªô Kh√≥:</label>
                    <select id="difficulty-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-lg rounded-md">
                        <option value="easy">D·ªÖ</option>
                        <option value="medium">Trung b√¨nh</option>
                        <option value="hard">Kh√≥</option>
                    </select>
                </div>

                <div id="host-team-name" class="mt-4 hidden">
                    <label for="team-name-input" class="block text-sm font-medium text-gray-700 mb-2">T√™n ƒë·ªôi:</label>
                    <input id="team-name-input" type="text" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-lg rounded-md"/>
                </div>
                
                <div id="member-difficulty-message" class="mt-4 text-center p-3 bg-indigo-50 border border-indigo-200 rounded-lg">
                    <p class="text-indigo-700 font-medium">ƒêang ch·ªù Ch·ªß ph√≤ng thi·∫øt l·∫≠p ƒë·ªô kh√≥...</p>
                </div>
            </div>
        </div>


        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="player-list-container">
        </div>

        <div class="mt-12 flex justify-center flex-col items-center">
            <a href="#"
                id="btn-start-game"
                class="inline-flex items-center justify-center px-10 py-4 border border-transparent text-xl font-bold rounded-lg text-white bg-green-600 hover:bg-green-700 transition duration-300 shadow-xl uppercase tracking-wider hidden disabled:opacity-50 disabled:cursor-not-allowed"
                >
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                B·∫Øt ƒë·∫ßu tr√≤ ch∆°i
            </a>
            
            <p id="waiting-for-host-message" class="text-xl font-semibold text-gray-700 p-4 border rounded-lg bg-yellow-50 mt-4">
                ƒêang ch·ªù Ch·ªß ph√≤ng b·∫Øt ƒë·∫ßu...
            </p>
        </div>

    </div>
</section>

@section Scripts {
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script> 
<script>
    const currentUserId = "@Model.CurrentUser?.Id";
    const currentUsername = "@Model.CurrentUser?.Account";
    const currentAvatar = "@Model.CurrentUser?.Avatar";

    let currentDifficulty = 'easy';
    let currentPlayers = [];
    const roomId = "@Model.Id";

    function getDifficultyText(value) {
        switch (value) {
            case 'easy': return 'D·ªÑ';
            case 'medium': return 'TRUNG B√åNH';
            case 'hard': return 'KH√ì';
            default: return 'Kh√¥ng x√°c ƒë·ªãnh';
        }
    }

    function getDifficultyInt(value) {
        console.log(value)
        switch (value) {
            case 'easy': return 1;
            case 'medium': return 2;
            case 'hard': return 3;
            default: return 0;
        }
    }
    
    function getDifficultyColorClass(value) {
        switch (value) {
            case 'easy': return 'text-green-600';
            case 'medium': return 'text-yellow-600';
            case 'hard': return 'text-red-600';
            default: return 'text-gray-600';
        }
    }


    $(document).ready(function () {
        if (!currentUserId || !currentUsername) {
            window.location.href = '/login';
            return;
        }

        if (!roomId) {
            alert("L·ªói: Kh√¥ng t√¨m th·∫•y ID ph√≤ng.");
            window.location.href = '/selection';
            return;
        }

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/gameHub")
            .withAutomaticReconnect()
            .build();

        let isHost = false;
        
        connection.on("PlayersUpdated", function (players) {
            console.log("Danh s√°ch ng∆∞·ªùi ch∆°i c·∫≠p nh·∫≠t:", players);
            currentPlayers = players;
            updatePlayerList(players);
        });
        
        connection.on("DifficultyUpdated", function (difficulty) {
            currentDifficulty = difficulty;
            const diffText = getDifficultyText(difficulty);
            const diffColor = getDifficultyColorClass(difficulty);
            
            $('#difficulty-display').text(diffText).removeClass('text-green-600 text-yellow-600 text-red-600').addClass(diffColor);
            
            if (!isHost) {
                $('#member-difficulty-message p').text(`ƒê·ªô kh√≥ ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t l√†: ${diffText}`);
            } else {
                $('#difficulty-select').val(currentDifficulty);
            }
        });


        connection.on("RoleAssigned", function (isHostRole) {
        isHost = isHostRole;
        
        if (isHost) {
            $('#btn-start-game').removeClass('hidden');
            $('#waiting-for-host-message').addClass('hidden');
            
            $('#host-difficulty-control').removeClass('hidden');
            $('#host-team-name').removeClass('hidden');
            $('#member-difficulty-message').addClass('hidden');
            
            $('#difficulty-select').val(currentDifficulty);

        } else {
            $('#btn-start-game').addClass('hidden');
            $('#waiting-for-host-message').removeClass('hidden');
            $('#host-difficulty-control').addClass('hidden');
            $('#host-team-name').addClass('hidden');
            $('#member-difficulty-message').removeClass('hidden');
        }
    });

        connection.on("GameStarted", function (roomId, difficulty, url) {
            console.log("chuy·ªÉn trang t·ªõi",url);
            window.location.href = `${url}`;
        });
        
        connection.on("KickedFromRoom", function () {
            alert("B·∫°n ƒë√£ b·ªã Ch·ªß ph√≤ng kick ra kh·ªèi ph√≤ng. B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn h∆∞·ªõng.");
            window.location.href = "/selection"; 
        });

        function updatePlayerList(players) {
            const container = $('#player-list-container'); 
            container.empty();
            
            players.forEach(player => {
                const isMe = player.userId === currentUserId;
                const hostClass = player.isHost ? "border-indigo-500 shadow-xl" : "border-gray-300 shadow-md";
                const bgClass = player.isHost ? "bg-indigo-100 border-indigo-400" : "bg-gray-200 border-gray-400";
                
                const hostLabel = player.isHost 
                    ? `<span class="absolute top-0 right-0 mt-2 mr-2 text-xs font-bold uppercase text-white bg-indigo-600 px-2 py-1 rounded-full">Ch·ªß Ph√≤ng</span>`
                    : '';

                let kickButton = '';
                if (isHost && !isMe) { 
                    kickButton = `
                        <button 
                            data-user-id="${player.userId}"
                            data-username="${player.username}"
                            class="kick-button absolute top-0 right-0 mb-2 mr-2 text-red-500  p-2  transition duration-150 hover:text-red-300"
                            title="Kick ${player.username} ra kh·ªèi ph√≤ng"
                        >
                            <span class="material-symbols-outlined text-lg">X</span>
                        </button>
                    `;
                }

                let avatarContent;
                if (player.avatar && player.avatar.trim() !== "") {
                    avatarContent = `<img src="${player.avatar}" alt="${player.username}" class="w-full h-full object-cover rounded-full" onerror="this.onerror=null; this.parentElement.innerHTML='<span class=\\'material-symbols-outlined text-gray-500 text-3xl\\'>person</span>';" />`;
                } else {
                    avatarContent = `
                        <div class="h-full w-full rounded-full flex items-center justify-center text-gray-700 font-extrabold text-2xl">
                            ${player.username.substring(0, 1).toUpperCase()}
                        </div>
                    `;
                }

                const playerHtml = `
                    <div class="p-5 border-2 ${hostClass} rounded-xl bg-white flex flex-col items-center space-y-3 relative min-h-[180px] hover:shadow-2xl transition duration-200">
                        ${hostLabel}
                        <div class="w-16 h-16 ${bgClass} rounded-full border-4 flex items-center justify-center overflow-hidden">
                            ${avatarContent}
                        </div>
                        <p class="font-bold text-lg text-gray-900 truncate w-full text-center">
                            ${player.username} ${isMe ? ' <span class="text-sm font-normal text-indigo-500">(B·∫°n)</span>' : ''}
                        </p>
                        <p class="text-sm text-gray-600">
                            ƒêi·ªÉm t√≠ch lu·ªπ: <span class="font-extrabold text-green-600">${player.score.toLocaleString('vi-VN')}</span>
                        </p>
                        ${kickButton}
                    </div>`;
                container.append(playerHtml);
            });
            
            for (let i = players.length; i < 4; i++) {
                 const emptySlotHtml = `
                    <div class="p-5 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 flex flex-col items-center justify-center space-y-2 min-h-[180px]">
                        <span class="text-gray-400 text-4xl">
                            ‚åõ 
                        </span>
                        <p class="font-semibold text-gray-500 text-base">ƒêang ch·ªù ng∆∞·ªùi ch∆°i...</p>
                    </div>`;
                container.append(emptySlotHtml);
            }
            
            attachKickEvents();
        }
        
        function attachKickEvents() {
            $('.kick-button').on('click', function(e) {
                e.preventDefault();
                const userIdToKick = $(this).data('user-id');
                const usernameToKick = $(this).data('username');

                if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kick ${usernameToKick} ra kh·ªèi ph√≤ng kh√¥ng?`)) {
                    connection.invoke("KickPlayer", roomId, userIdToKick).catch(function (err) {
                        return console.error("Error kicking player: " + err.toString());
                    });
                }
            });
        }

        connection.start().then(function () {
            connection.invoke("JoinRoom", roomId, currentUserId, currentUsername, currentAvatar).catch(function (err) {
                return console.error(err.toString());
            });
        }).catch(function (err) {
            return console.error("SignalR Connection Error: " + err.toString());
        });
        
        $('#difficulty-select').on('change', function() {
            const newDifficulty = $(this).val();
            if (isHost) {
                connection.invoke("SetDifficulty", roomId, newDifficulty).catch(function (err) {
                    return console.error("Error setting difficulty: " + err.toString());
                });
            }
        });

        function generateTeamId() {
            const randomDigits = Math.floor(10000 + Math.random() * 90000);
            return `T-${randomDigits}`;
        }


        $('#btn-start-game').on('click',async function(e) {
            if($('#team-name-input').val()==""){
                alert("Vui l√≤ng nh·∫≠p t√™n ƒë·ªôi tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu tr√≤ ch∆°i.");
                return;
            }
            
            const diffInt = $('#difficulty-select').val();
            const apiEndpoint = `/api/Challenge/random?difficulty=${getDifficultyInt(diffInt)}`;
            e.preventDefault();
            if (isHost) {
                try {
                    const response = await fetch(apiEndpoint, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const challengeId = data.id;

                        const redirectUrl = `/play?players=${currentPlayers.length}&difficulty=${getDifficultyInt($("#difficulty-select").val())}&challenge_id=${challengeId}&teamId=${generateTeamId()}&roomId=${roomId}&teamName=${$("#team-name-input").val()}`;
                        connection.invoke("StartGame", roomId, currentDifficulty, redirectUrl).catch(function (err) {
                            return console.error("Error starting game: " + err.toString());
                        });
                    } else if (response.status === 404) {
                        const errorData = await response.json();
                        alert(`L·ªói: ${errorData.message || 'Kh√¥ng t√¨m th·∫•y ƒë·ªÅ b√†i n√†o cho ƒë·ªô kh√≥ n√†y.'}`);
                    } else {
                        const errorData = await response.json();
                        alert(`L·ªói khi l·∫•y ƒë·ªÅ b√†i: ${errorData.message || 'ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.'}`);
                    }
                } catch (error) {
                    console.error('L·ªói API:', error);
                    alert('L·ªói k·∫øt n·ªëi ho·∫∑c x·ª≠ l√Ω d·ªØ li·ªáu.');
                }
            } else {
                alert("B·∫°n kh√¥ng ph·∫£i Ch·ªß ph√≤ng ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ ch∆°i.");
            }
        });

    });
</script>
}